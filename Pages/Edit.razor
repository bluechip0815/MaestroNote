@using System.ComponentModel.DataAnnotations
@using MaestroNotes.Data
@inject MusicService Service
@inject AiService AiService
@inject IJSRuntime JSRuntime

<EditForm Model="@currentRecord">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- BEZEICHNUNG -->
    <div class="form-group row mb-2">
        <label class="col-sm-2 col-form-label">Bezeichnung:</label>
        <div class="col-sm-10">
            <InputText class="form-control" @bind-Value="currentRecord.Bezeichnung" />
        </div>
    </div>

    <!-- HEADER FIELDS SPLIT -->
    <div class="row">
        <!-- LEFT COLUMN: Orchester & Dirigent -->
        <div class="col-md-6">
            <!-- ORCHESTER -->
            <div class="form-group row mb-2">
                <label class="col-sm-3 col-form-label">Orchester:</label>
                <div class="col-sm-7">
                    <select class="form-control" @bind="currentRecord.OrchesterId">
                        <option value="">(None)</option>
                        @foreach (var o in OrchesterList)
                        {
                            <option value="@o.Id">@o.Name</option>
                        }
                    </select>
                </div>
                <div class="col-sm-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => showNewOrchester = true">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- DIRIGENT -->
            <div class="form-group row mb-2">
                <label class="col-sm-3 col-form-label">Dirigent:</label>
                <div class="col-sm-7">
                    <select class="form-control" @bind="currentRecord.DirigentId">
                        <option value="">(None)</option>
                        @foreach (var d in DirigentenList)
                        {
                            <option value="@d.Id">@d.Name, @d.Vorname</option>
                        }
                    </select>
                </div>
                <div class="col-sm-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => showNewDirigent = true">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Spielsaison, Datum, Ort -->
        <div class="col-md-6">
            <!-- Spielsaison & Datum Side-by-Side -->
            <div class="row mb-2">
                <div class="col-6">
                    <div class="form-group row">
                        <label class="col-sm-5 col-form-label px-0 text-end pe-2">Spielsaison:</label>
                        <div class="col-sm-7 px-0 pe-2">
                            <select id="Spielsaison" class="form-control" @bind="currentRecord.Spielsaison">
                                @foreach(string n in Service.GetSpielSaisonList())
                                {
                                    if (n!="")
                                    {
                                        <option value="@n">@n</option>
                                    }
                                }
                            </select>
                            <ValidationMessage For="@(() => currentRecord.Spielsaison)" />
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label px-0 text-end pe-2">Datum:</label>
                        <div class="col-sm-8 px-0 pe-3">
                            <InputDate id="Datum" class="form-control" @bind-Value="currentRecord.Datum" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ort -->
            <div class="form-group row mb-2">
                <label class="col-sm-2 col-form-label">Ort:</label>
                <div class="col-sm-8">
                     <select id="Ort" class="form-control" @bind="currentRecord.OrtId">
                        <option value="">(None)</option>
                        @foreach (var o in OrteList)
                        {
                            <option value="@o.Id">@o.Name</option>
                        }
                    </select>
                    <ValidationMessage For="@(() => currentRecord.OrtId)" />
                </div>
                <div class="col-sm-2">
                     <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => showNewOrt = true">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WERKE & SOLISTEN SPLIT -->
    <div class="row mt-4">
        <!-- WERKE -->
        <div class="col-md-6">
            <details class="spoiler">
                <summary class="spoiler-header">Werke (@currentRecord.Werke.Count)</summary>
                <div class="spoiler-content">
                    <table class="table table-sm table-bordered">
                        <tbody>
                            @foreach (var w in currentRecord.Werke)
                            {
                                <tr>
                                    <td>@w.Name (@(w.Komponist?.Name ?? "Unbekannt"))</td>
                                    <td style="width: 50px;">
                                        <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveWerk(w)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="row">
                        <div class="col-sm-7">
                            <select class="form-control" @bind="selectedWerkToAddId">
                                <option value="">Werk auswählen...</option>
                                @foreach (var w in WerkeList)
                                {
                                    <option value="@w.Id">@w.Name (@(w.Komponist?.Name ?? "Unbekannt"))</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-5 d-flex">
                            <button type="button" class="btn btn-sm btn-secondary me-1" @onclick="AddSelectedWerk">Hinzufügen</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => showNewWerk = true">
                                 + Neu
                            </button>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- SOLISTEN -->
        <div class="col-md-6">
            <details class="spoiler">
                <summary class="spoiler-header">Solisten (@currentRecord.Solisten.Count)</summary>
                <div class="spoiler-content">
                    <table class="table table-sm table-bordered">
                        <tbody>
                            @foreach (var s in currentRecord.Solisten)
                            {
                                <tr>
                                    <td>@s.Name, @s.Vorname</td>
                                    <td style="width: 50px;">
                                        <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoveSolist(s)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="row">
                        <div class="col-sm-7">
                            <select class="form-control" @bind="selectedSolistToAddId">
                                <option value="">Solist auswählen...</option>
                                @foreach (var s in SolistenList)
                                {
                                    <option value="@s.Id">@s.Name, @s.Vorname</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-5 d-flex">
                            <button type="button" class="btn btn-sm btn-secondary me-1" @onclick="AddSelectedSolist">Hinzufügen</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => showNewSolist = true">
                                 + Neu
                            </button>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- BEWERTUNG -->
    <div class="form-group mt-3">
        <label for="Bewertung">Bewertung:</label>
        <InputTextArea id="Bewertung" class="form-control" @bind-Value="currentRecord.Bewertung" rows="5" />
        <ValidationMessage For="@(() => currentRecord.Bewertung)" />
    </div>

    <!-- ACTIONS -->
    <div class="mt-4">
        <button type="button" class="btn btn-success" @onclick="() => Close(true)">
            <i class="fas fa-save"></i> Speichern
        </button>
        <button type="button" class="btn btn-secondary ms-2" @onclick="() => Close(false)">
            <i class="fas fa-times"></i> Abbrechen
        </button>
    </div>

</EditForm>

<!-- MODALS (Simple overlays) -->
@if (showNewOrchester)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neues Orchester</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewOrchester = false"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Name" @bind="newOrchester.Name" />
                    <div class="mb-2">
                        <label>Gegründet:</label>
                        <input type="date" class="form-control" @bind="newOrchester.Founded" />
                    </div>
                    <div class="mb-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newOrchester.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillOrchesterAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewOrchester = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewOrchester">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewOrt)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Ort</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewOrt = false"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Name" @bind="newOrt.Name" />
                    <div class="mb-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newOrt.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillOrtAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewOrt = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewOrt">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewDirigent)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Dirigent</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewDirigent = false"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Vorname" @bind="newDirigent.Vorname" />
                    <input class="form-control mb-2" placeholder="Name" @bind="newDirigent.Name" />
                    <div class="mb-2">
                        <label>Geboren:</label>
                        <input type="date" class="form-control" @bind="newDirigent.Born" />
                    </div>
                    <div class="mb-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newDirigent.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillDirigentAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewDirigent = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewDirigent">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewSolist)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Solist</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewSolist = false"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Vorname" @bind="newSolist.Vorname" />
                    <input class="form-control mb-2" placeholder="Name" @bind="newSolist.Name" />
                    <div class="mb-2">
                        <label>Geboren:</label>
                        <input type="date" class="form-control" @bind="newSolist.Born" />
                    </div>
                    <div class="mb-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newSolist.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillSolistAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewSolist = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewSolist">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewWerk)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neues Werk</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewWerk = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>Komponist (erforderlich):</label>
                        <div class="input-group">
                             <select class="form-control" @bind="newWerk.KomponistId">
                                <option value="">Bitte wählen...</option>
                                @foreach (var k in KomponistenList)
                                {
                                    <option value="@k.Id">@k.Name, @k.Vorname</option>
                                }
                            </select>
                            <button class="btn btn-outline-secondary" type="button" @onclick="() => showNewKomponist = true">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <input class="form-control" placeholder="Werk Name" @bind="newWerk.Name" />
                    <div class="mb-2 mt-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newWerk.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillWerkAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewWerk = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewWerk">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewKomponist)
{
    <div class="modal-backdrop show" style="z-index: 1060;"></div>
    <div class="modal show d-block" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Komponist</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewKomponist = false"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Vorname" @bind="newKomponist.Vorname" />
                    <input class="form-control mb-2" placeholder="Name" @bind="newKomponist.Name" />
                    <div class="mb-2">
                        <label>Geboren:</label>
                        <input type="date" class="form-control" @bind="newKomponist.Born" />
                    </div>
                    <div class="mb-2">
                        <label>Notiz:</label>
                        <textarea class="form-control" rows="3" @bind="newKomponist.Note"></textarea>
                    </div>
                    <div class="mb-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillKomponistAi">AI Vervollständigen</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewKomponist = false">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewKomponist">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public MusicRecord currentRecord { get; set; } = new();

    [Parameter]
    public EventCallback<bool> CloseCallback { get; set; }

    // Lists
    private List<Orchester> OrchesterList = new();
    private List<Dirigent> DirigentenList = new();
    private List<Solist> SolistenList = new();
    private List<Werk> WerkeList = new();
    private List<Komponist> KomponistenList = new();
    private List<Ort> OrteList = new();

    // UI State for Modals
    private bool showNewOrchester = false;
    private bool showNewDirigent = false;
    private bool showNewSolist = false;
    private bool showNewWerk = false;
    private bool showNewKomponist = false;
    private bool showNewOrt = false;

    // Temporary objects for creation
    private Orchester newOrchester = new();
    private Dirigent newDirigent = new();
    private Solist newSolist = new();
    private Werk newWerk = new();
    private Komponist newKomponist = new();
    private Ort newOrt = new();

    // Selection State for Add to List
    private int selectedWerkToAddId;
    private int selectedSolistToAddId;

    protected override void OnInitialized()
    {
        LoadLists();
    }

    private void LoadLists()
    {
        OrchesterList = Service.GetAllOrchester();
        DirigentenList = Service.GetAllDirigenten();
        SolistenList = Service.GetAllSolisten();
        WerkeList = Service.GetAllWerke();
        KomponistenList = Service.GetAllKomponisten();
        OrteList = Service.GetAllOrte();
    }

    private void Close(bool result)
    {
        CloseCallback.InvokeAsync(result);
    }

    // --- AI Helpers ---

    private async Task FillOrchesterAi()
    {
        if (string.IsNullOrWhiteSpace(newOrchester.Name))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Namen ein.");
            return;
        }

        try
        {
            var result = await AiService.RequestAiData(newOrchester.Name, "Orchester");
            if (result is AiOrchesterResponseDto dto)
            {
                newOrchester.Founded = dto.Founded;
                newOrchester.Note = dto.Note;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    private async Task FillDirigentAi()
    {
         if (string.IsNullOrWhiteSpace(newDirigent.Name))
        {
             await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Namen ein.");
             return;
        }

        try
        {
            // Combined name for better context if needed
            string fullName = $"{newDirigent.Vorname} {newDirigent.Name}".Trim();
            var result = await AiService.RequestAiData(fullName, "Dirigent");
            if (result is AiDirigentResponseDto dto)
            {
                newDirigent.Born = dto.Born;
                newDirigent.Note = dto.Note;
            }
        }
        catch (Exception ex)
        {
             await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    private async Task FillSolistAi()
    {
         if (string.IsNullOrWhiteSpace(newSolist.Name))
        {
             await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Namen ein.");
             return;
        }

        try
        {
            string fullName = $"{newSolist.Vorname} {newSolist.Name}".Trim();
            var result = await AiService.RequestAiData(fullName, "Solist");
            if (result is AiSolistResponseDto dto)
            {
                newSolist.Born = dto.Born;
                newSolist.Note = dto.Note;
            }
        }
        catch (Exception ex)
        {
             await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    private async Task FillKomponistAi()
    {
         if (string.IsNullOrWhiteSpace(newKomponist.Name))
        {
             await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Namen ein.");
             return;
        }

        try
        {
            string fullName = $"{newKomponist.Vorname} {newKomponist.Name}".Trim();
            var result = await AiService.RequestAiData(fullName, "Komponist");
            if (result is AiKomponistResponseDto dto)
            {
                newKomponist.Born = dto.Born;
                newKomponist.Note = dto.Note ?? "";
            }
        }
        catch (Exception ex)
        {
             await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    private async Task FillOrtAi()
    {
        if (string.IsNullOrWhiteSpace(newOrt.Name))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Namen ein.");
            return;
        }

        try
        {
            var result = await AiService.RequestAiData(newOrt.Name, "Ort");
            if (result is AiOrtResponseDto dto)
            {
                newOrt.Note = dto.Note;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    private async Task FillWerkAi()
    {
        if (string.IsNullOrWhiteSpace(newWerk.Name))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Bitte geben Sie zuerst einen Werknamen ein.");
            return;
        }

        if (newWerk.KomponistId == null || newWerk.KomponistId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Bitte wählen Sie zuerst einen Komponisten aus.");
            return;
        }

        try
        {
            var selectedKomponist = KomponistenList.FirstOrDefault(k => k.Id == newWerk.KomponistId);
            string komponistName = selectedKomponist != null
                ? $"{selectedKomponist.Vorname} {selectedKomponist.Name}".Trim()
                : "Unknown";

            // Argument are Name and Komponist
            string query = $"{newWerk.Name} by {komponistName}";

            var result = await AiService.RequestAiData(query, "Werk");
            if (result is AiWerkResponseDto dto)
            {
                newWerk.Note = dto.Note;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Fehler bei der AI-Abfrage: {ex.Message}");
        }
    }

    // --- Save Helpers ---

    private async Task SaveNewOrchester()
    {
        if (!string.IsNullOrWhiteSpace(newOrchester.Name))
        {
            await Service.AddOrchester(newOrchester);
            LoadLists();
            // Auto-select the new one
            currentRecord.OrchesterId = newOrchester.Id;
            newOrchester = new(); // Reset
            showNewOrchester = false;
        }
    }

    private async Task SaveNewDirigent()
    {
        if (!string.IsNullOrWhiteSpace(newDirigent.Name))
        {
            await Service.AddDirigent(newDirigent);
            LoadLists();
            // Auto-select
            currentRecord.DirigentId = newDirigent.Id;
            newDirigent = new();
            showNewDirigent = false;
        }
    }

    private async Task SaveNewSolist()
    {
        if (!string.IsNullOrWhiteSpace(newSolist.Name))
        {
            await Service.AddSolist(newSolist);
            LoadLists();
            // Auto-add to list? Or just make available?
            // Let's add it to the current record directly as a convenience
            // Note: EF might get confused if we add the same instance from context A to context B,
            // but here we are just adding to the list.
            // Ideally we reload the object from the list we just fetched.
            var created = SolistenList.FirstOrDefault(s => s.Id == newSolist.Id);
            if (created != null)
            {
                currentRecord.Solisten.Add(created);
            }

            newSolist = new();
            showNewSolist = false;
        }
    }

    private async Task SaveNewWerk()
    {
        if (!string.IsNullOrWhiteSpace(newWerk.Name) && newWerk.KomponistId != null)
        {
            await Service.AddWerk(newWerk);
            LoadLists();

            var created = WerkeList.FirstOrDefault(w => w.Id == newWerk.Id);
            if (created != null)
            {
                currentRecord.Werke.Add(created);
            }

            newWerk = new();
            showNewWerk = false;
        }
    }

    private async Task SaveNewKomponist()
    {
        if (!string.IsNullOrWhiteSpace(newKomponist.Name))
        {
            await Service.AddKomponist(newKomponist);
            LoadLists();

            // Auto-select the new one in the New Werk modal
            newWerk.KomponistId = newKomponist.Id;

            newKomponist = new();
            showNewKomponist = false;
        }
    }

    private async Task SaveNewOrt()
    {
        if (!string.IsNullOrWhiteSpace(newOrt.Name))
        {
            await Service.AddOrt(newOrt);
            LoadLists();

            currentRecord.OrtId = newOrt.Id;
            newOrt = new();
            showNewOrt = false;
        }
    }

    // --- List Management ---

    private void AddSelectedWerk()
    {
        var werk = WerkeList.FirstOrDefault(w => w.Id == selectedWerkToAddId);
        if (werk != null && !currentRecord.Werke.Any(w => w.Id == werk.Id))
        {
            currentRecord.Werke.Add(werk);
        }
        selectedWerkToAddId = 0; // Reset dropdown
    }

    private void RemoveWerk(Werk w)
    {
        currentRecord.Werke.Remove(w);
    }

    private void AddSelectedSolist()
    {
        var solist = SolistenList.FirstOrDefault(s => s.Id == selectedSolistToAddId);
        if (solist != null && !currentRecord.Solisten.Any(s => s.Id == solist.Id))
        {
            currentRecord.Solisten.Add(solist);
        }
        selectedSolistToAddId = 0;
    }

    private void RemoveSolist(Solist s)
    {
        currentRecord.Solisten.Remove(s);
    }
}
