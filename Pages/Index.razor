@page "/"

@using Microsoft.AspNetCore.Components.Web
@using MaestroNotes.Data
@using MaestroNotes.Shared
@using static MaestroNotes.Data.MusicService

@inject MusicService Service
@inject IJSRuntime JS

<PageTitle>Meine Konzerte</PageTitle>

@if (showMessage)
{
    <div class="alert alert-info">
        @messageText
    </div>
}

@if (PageEnabled != AccessType.None)
{
    @if (EditMusicRecord is not null)
    {
        <h3>Bearbeiten</h3>
        <Edit currentRecord="EditMusicRecord" CloseCallback="@CloseEdit" />
    }
    else
    {
        <div class="search-container" style="display: flex; flex-direction: row; align-items: center; gap: 10px; margin-bottom: 20px;">
            <select class="form-select" style="width: auto;" @bind="searchCategory">
                @foreach (var cat in searchCategories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>

            @if (searchCategory == "Datum")
            {
                <span class="date-search">
                    <span>von</span>
                    <input type="date" class="form-control" style="width: auto;" @bind="searchDateFrom" />
                    <span>bis</span>
                    <input type="date" class="form-control" style="width: auto;" @bind="searchDateTo" />
                </span>
            }
            else if (searchCategory == "Note")
            {
                <input type="text" class="form-control" style="width: 200px;" @bind="searchTerm" placeholder="(* und ? möglich)" />
            }
            else
            {
                <select class="form-select" style="width: auto;" @bind="searchTerm">
                    <option value="">Bitte wählen...</option>
                    @if (searchCategory == "Werk")
                    {
                        @foreach (var item in availableWerke)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Komponist")
                    {
                        @foreach (var item in availableKomponisten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Dirigent")
                    {
                        @foreach (var item in availableDirigenten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Solist")
                    {
                        @foreach (var item in availableSolisten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Orchester")
                    {
                        @foreach (var item in availableOrchester)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Ort")
                    {
                        @foreach (var item in availableOrte)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Saisson")
                    {
                        @foreach (var item in availableSaisons)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                </select>
            }

            <button class="btn btn-secondary" @onclick="RefreshList">Zeige</button>

            <span>@GetNumber() Datensätze</span>

            <select id="number" value="@selectedLimit" @onchange="Display" class="form-select" style="width:auto;">
                @foreach (var opt in limitOptions)
                {
                    <option value="@opt.Key">@opt.Value</option>
                }
            </select>
            @if (PageEnabled == AccessType.ReadWrite)
            {
                <button class="btn btn-primary" @onclick="() => AddNew()" title="Neuer Eintrag">
                    <i class="fas fa-plus"></i>
                </button>
            }
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle modern-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 20%;">Komponist</th>
                        <th style="width: 25%;">Werk</th>
                        <th style="width: 20%;">Orchester / Dirigent</th>
                        <th style="width: 15%;">Solist</th>
                        <th style="width: 10%;">Saison</th>
                        <th style="width: 10%;">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var record in MusicRecords)
                    {
                        <tr>
                            <td class="fw-bold text-primary">@record.KomponistNames</td>
                            <td class="fw-bold">@record.WerkNames</td>
                            <td>
                                <div>@record.OrchesterName</div>
                                <div class="text-muted small">@record.DirigentName</div>
                            </td>
                            <td class="small">@record.SolistNames</td>
                            <td class="small text-muted">@record.Spielsaison</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-link text-dark dropdown-toggle" type="button" id="dropdownMenuButton-@record.Id" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton-@record.Id">
                                        <li>
                                            <a class="dropdown-item" role="button" @onclick="() => OpenNoteModal(record)">
                                                <i class="fas fa-envelope me-2 text-warning"></i> Note
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" role="button" @onclick="() => OpenDetailsModal(record)">
                                                <i class="fas fa-info-circle me-2 text-info"></i> Details
                                            </a>
                                        </li>
                                        @if (PageEnabled == AccessType.ReadWrite)
                                        {
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item" role="button" @onclick="() => OpenUploadModal(record)">
                                                    <i class="fas fa-upload me-2 text-success"></i> Upload
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" role="button" @onclick="() => Edit(record.Id)">
                                                    <i class="fas fa-edit me-2 text-primary"></i> Bearbeiten
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" role="button" @onclick="() => OpenDeleteModal(record)">
                                                    <i class="fas fa-trash me-2"></i> Löschen
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}
else
{
    <div class="text-center mt-5">
        <h3 class="mb-4">Meine Konzerte</h3>
        <p> <img src="Images/dresden.jpg" class="img-fluid rounded shadow" style="max-height: 500px;" /> </p>
        <div class="form-group mt-3 d-inline-block">
            <label class="me-2">Logon:</label>
            <input type="text" @oninput="PageEnabler" id="EnablePage" class="form-control d-inline-block" style="width: 100px;" />
        </div>
    </div>
}

@* --- Modals --- *@

<ModalDialog Title="Notiz bearbeiten" Show="@ShowNoteModal" OnClose="@CloseNoteModal" ShowFooter="true">
    <ChildContent>
        @if (NoteRecord != null)
        {
            <div class="form-group">
                <label class="form-label">Bewertung / Notiz:</label>
                <textarea class="form-control" rows="10" @bind="NoteRecord.Bewertung"></textarea>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-secondary" @onclick="() => CloseNoteModal(false)">Abbrechen</button>
        <button class="btn btn-primary" @onclick="SaveNote">Speichern</button>
    </FooterContent>
</ModalDialog>

<ModalDialog Title="Details & Dokumente" Show="@ShowDetailsModal" OnClose="@CloseDetailsModal" ShowFooter="false">
    <ChildContent>
        @if (DetailsRecord != null)
        {
            <div class="mb-3">
                <h5>@DetailsRecord.KomponistNames: @DetailsRecord.WerkNames</h5>
                <p>
                    <strong>Ort:</strong> @DetailsRecord.Ort <br />
                    <strong>Datum:</strong> @DetailsRecord.Datum.ToString("dd.MM.yyyy")
                </p>
            </div>

            <hr />

            @if (Service.HasDocuments(DetailsRecord.Id))
            {
                <h6>Dokumente:</h6>
                @foreach (DOC item in Service.GetDocuments(DetailsRecord.Id))
                {
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                        <a href="@item.path" target="_blank" class="text-decoration-none">
                            <i class="fas fa-file-pdf me-2 text-danger"></i> @item.fn
                        </a>
                        @if (PageEnabled == AccessType.ReadWrite)
                        {
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteFile(item.id)">
                                <i class="fas fa-trash"></i>
                            </button>
                        }
                    </div>
                }

                <h6 class="mt-3">Bilder:</h6>
                @foreach (DOC item in Service.GetImages(DetailsRecord.Id))
                {
                    <div class="mb-3 p-2 border rounded">
                        <img src="@item.path" alt="@item.fn" class="img-fluid mb-2" />
                        <div class="d-flex justify-content-between">
                             <span class="text-muted small">@item.fn</span>
                             @if (PageEnabled == AccessType.ReadWrite)
                             {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteFile(item.id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                             }
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Keine Dokumente oder Bilder vorhanden.</p>
            }
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Datei hochladen" Show="@ShowUploadModal" OnClose="@CloseUploadModalWrapper" ShowFooter="false">
    <ChildContent>
        @if (UploadRecord != null)
        {
             <Upload currentRecord="@UploadRecord" CloseUploadCallback="@CloseUploadCallback" />
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Datensatz löschen" Show="@ShowDeleteModal" OnClose="@CloseDeleteModalWrapper" ShowFooter="false">
    <ChildContent>
        <div class="alert alert-warning">
            Möchten Sie diesen Datensatz wirklich löschen?
        </div>
        @if (DeleteRecordId != 0)
        {
            <Delete CloseDeleteCallback="@CloseDeleteCallback" />
        }
    </ChildContent>
</ModalDialog>


@code {
    private Dictionary<int, string> limitOptions = new() { { 5, "Letzte 5" }, { 10, "Letzte 10" }, { 0, "All" } };
    private int selectedLimit = 5;

    // Search properties
    private List<string> searchCategories = new() { "Werk", "Komponist", "Dirigent", "Ort", "Solist", "Orchester", "Note", "Datum", "Saisson" };

    private string _searchCategory = "Werk";
    private string searchCategory
    {
        get => _searchCategory;
        set
        {
            _searchCategory = value;
            searchTerm = "";
            searchDateFrom = null;
            searchDateTo = null;
        }
    }

    private string searchTerm = "";
    private DateTime? searchDateFrom;
    private DateTime? searchDateTo;

    // Dropdown lists
    private List<string> availableWerke = new();
    private List<string> availableKomponisten = new();
    private List<string> availableDirigenten = new();
    private List<string> availableSolisten = new();
    private List<string> availableOrchester = new();
    private List<string> availableOrte = new();
    private List<string> availableSaisons = new();

    private List<MusicRecordDisplayDto> MusicRecords = new();

    protected override void OnInitialized()
    {
        // Load lists
        availableWerke = Service.GetUsedWerkeNames();
        availableKomponisten = Service.GetUsedKomponistenNames();
        availableDirigenten = Service.GetUsedDirigentenNames();
        availableSolisten = Service.GetUsedSolistenNames();
        availableOrchester = Service.GetUsedOrchesterNames();
        availableOrte = Service.GetUsedOrte();
        availableSaisons = Service.GetUsedSaisons();

        RefreshList();
    }

    private void RefreshList()
    {
        MusicRecords = Service.GetDisplayRecords(searchCategory, searchTerm, searchDateFrom, searchDateTo, selectedLimit);
    }

    private void Display(ChangeEventArgs a)
    {
        if (int.TryParse(a?.Value?.ToString(), out int val))
        {
            selectedLimit = val;
            RefreshList();
        }
    }

    private string GetNumber()
    {
        return MusicRecords.Count.ToString();
    }

    private AccessType PageEnabled = AccessType.None;
    void PageEnabler(ChangeEventArgs eventArgs)
    {
        if (eventArgs != null)
        {
            var t = eventArgs.Value?.ToString() ?? string.Empty;
            if (t.Length >= 4)
            {
                PageEnabled = Service.EnablerTest(t);
                StateHasChanged();
            }
        }
    }

    // --- Modal State Management ---

    // Note Modal
    private bool ShowNoteModal = false;
    private MusicRecord? NoteRecord;

    private void OpenNoteModal(MusicRecordDisplayDto record)
    {
        NoteRecord = Service.GetRecordById(record.Id);
        ShowNoteModal = true;
    }

    private async Task SaveNote()
    {
        if (NoteRecord != null)
        {
            await Service.SaveDataSet(NoteRecord);
            ShowNoteModal = false;
            NoteRecord = null;
            RefreshList();
        }
    }

    private Task CloseNoteModal(bool result)
    {
        ShowNoteModal = false;
        NoteRecord = null;
        return Task.CompletedTask;
    }

    // Details Modal
    private bool ShowDetailsModal = false;
    private MusicRecordDisplayDto? DetailsRecord;

    private void OpenDetailsModal(MusicRecordDisplayDto record)
    {
        DetailsRecord = record;
        ShowDetailsModal = true;
    }

    private Task CloseDetailsModal(bool result)
    {
        ShowDetailsModal = false;
        DetailsRecord = null;
        return Task.CompletedTask;
    }

    // Upload Modal
    private bool ShowUploadModal = false;
    private MusicRecord? UploadRecord;

    private void OpenUploadModal(MusicRecordDisplayDto record)
    {
        UploadRecord = Service.GetRecordById(record.Id);
        ShowUploadModal = true;
    }

    private Task CloseUploadModalWrapper(bool result)
    {
        ShowUploadModal = false;
        UploadRecord = null;
        return Task.CompletedTask;
    }

    private async Task CloseUploadCallback(bool result)
    {
        ShowUploadModal = false;
        UploadRecord = null;
        RefreshList(); // Refresh to show potential changes if any, though uploads are separate
        await Task.CompletedTask;
    }

    // Delete Modal
    private bool ShowDeleteModal = false;
    private int DeleteRecordId = 0;

    private void OpenDeleteModal(MusicRecordDisplayDto record)
    {
        DeleteRecordId = record.Id;
        ShowDeleteModal = true;
    }

    private Task CloseDeleteModalWrapper(bool result)
    {
        ShowDeleteModal = false;
        DeleteRecordId = 0;
        return Task.CompletedTask;
    }

    private async Task CloseDeleteCallback(bool del)
    {
        if (del && DeleteRecordId != 0)
        {
            await Service.DeleteDataSet(DeleteRecordId);
            RefreshList();
            StateHasChanged();
        }
        ShowDeleteModal = false;
        DeleteRecordId = 0;
    }

    // --- Edit (Full) ---
    private MusicRecord? EditMusicRecord;

    private void AddNew()
    {
        EditMusicRecord = new MusicRecord();
    }

    private void Edit(int id)
    {
        EditMusicRecord = Service.GetRecordById(id);
    }

    private async Task CloseEdit(bool result)
    {
        if (result && EditMusicRecord is not null)
            await Save(EditMusicRecord);
        EditMusicRecord = null;
        RefreshList();
    }

    private async Task Save(MusicRecord? n)
    {
        if (n is null) return;
        await Service.SaveDataSet(n);
    }

    // --- Document Deletion ---
    private async Task DeleteFile(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirmDeletion", "Soll die Datei wirklich gelöscht werden?");
        if (confirmed)
        {
            string message = await Service.DeleteDocument(id);
            await ShowInfo(message);
            // Refresh details view if open? The service returns void, we manually updated lists.
            // But Service.GetDocuments pulls from DB or folder.
            // StateHasChanged handles re-render of the modal content.
        }
    }

    private bool showMessage = false;
    private string messageText = "";
    private async Task ShowInfo(string m)
    {
        messageText = m;
        showMessage = true;
        StateHasChanged();
        await Task.Delay(3000);
        showMessage = false;
        StateHasChanged();
    }
}
