@page "/"

@using System.Text.Json
@using System.Text.Json.Serialization
@using MaestroNotes.Data
@using MaestroNotes.Shared
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Logging
@using static MaestroNotes.Services.MusicService

@inject MusicService Service
@inject AiService AiService
@inject IJSRuntime JS
@inject ILogger<Index> Logger

<PageTitle>Meine Konzerte</PageTitle>

@if (showMessage)
{
    <div class="alert alert-info">
        @messageText
    </div>
}

<AuthorizeView>
    <Authorized>
        @if (EditMusicRecord is not null)
        {
            <h3>Bearbeiten</h3>
            <Edit currentRecord="EditMusicRecord" CloseCallback="@CloseEdit" />
        }
        else
        {
            <div class="search-container" style="display: flex; flex-direction: row; align-items: center; gap: 10px; margin-bottom: 20px;">
                <select class="form-select" style="width: auto;" @bind="searchCategory">
                    @foreach (var cat in searchCategories)
                    {
                        <option value="@cat">@cat</option>
                    }
                </select>

                @if (searchCategory == "Datum")
                {
                    <span class="date-search">
                        <span>von</span>
                        <input type="date" class="form-control" style="width: auto;" @bind="searchDateFrom" />
                        <span>bis</span>
                        <input type="date" class="form-control" style="width: auto;" @bind="searchDateTo" />
                    </span>
                }
                else if (searchCategory == "Note")
                {
                    <input type="text" class="form-control" style="width: 200px;" @bind="searchTerm" placeholder="(* und ? möglich)" />
                }
                else
                {
                    <select class="form-select" style="width: auto;" @bind="searchTerm">
                        <option value="">Bitte wählen...</option>
                        @if (searchCategory == "Werk")
                        {
                            @foreach (var item in availableWerke)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Komponist")
                        {
                            @foreach (var item in availableKomponisten)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Dirigent")
                        {
                            @foreach (var item in availableDirigenten)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Solist")
                        {
                            @foreach (var item in availableSolisten)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Orchester")
                        {
                            @foreach (var item in availableOrchester)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Ort")
                        {
                            @foreach (var item in availableOrte)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                        else if (searchCategory == "Saisson")
                        {
                            @foreach (var item in availableSaisons)
                            {
                                <option value="@item">@item</option>
                            }
                        }
                    </select>
                }

                <button class="btn btn-secondary" @onclick="RefreshList">Zeige</button>

                <div class="dropdown d-inline-block ms-2">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownSpecials" data-bs-toggle="dropdown" aria-expanded="false">
                        Specials
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownSpecials">
                        <li><a class="dropdown-item" role="button" @onclick="OpenAiFillModal">KI Vervollständigen</a></li>
                        <li><a class="dropdown-item" role="button" @onclick="OpenExportModal">Export</a></li>
                        <AuthorizeView Roles="Admin" Context="userAdminContext">
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" role="button" @onclick="OpenUserListModal">Benutzerverwaltung</a></li>
                        </AuthorizeView>
                    </ul>
                </div>

                <span>@GetNumber() Datensätze</span>

                <select id="number" value="@selectedLimit" @onchange="Display" class="form-select" style="width:auto;">
                    @foreach (var opt in limitOptions)
                    {
                        <option value="@opt.Key">@opt.Value</option>
                    }
                </select>

                <AuthorizeView Roles="Admin, Operator" Context="adminContext">
                    <div class="dropdown d-inline-block me-2">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMaster" data-bs-toggle="dropdown" aria-expanded="false">
                            Stammdaten
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMaster">
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Dirigent")'>Dirigent</a></li>
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Orchester")'>Orchester</a></li>
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Solist")'>Solist</a></li>
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Werk")'>Werk</a></li>
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Komponist")'>Komponist</a></li>
                            <li><a class="dropdown-item" role="button" @onclick='() => OpenMasterList("Ort")'>Ort</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" @onclick="() => AddNew()" title="Neuer Eintrag">
                        <i class="fas fa-plus"></i>
                    </button>
                </AuthorizeView>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle modern-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%;">Komponist</th>
                            <th style="width: 25%;">Werk</th>
                            <th style="width: 20%;">Orchester / Dirigent</th>
                            <th style="width: 15%;">Solist</th>
                            <th style="width: 10%;">Saison</th>
                            <th style="width: 10%;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in MusicRecords)
                        {
                            <tr>
                                <td class="fw-bold text-primary">@record.KomponistNames</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(record.Bezeichnung))
                                    {
                                        <div class="small text-muted">@record.Bezeichnung</div>
                                    }
                                    <div class="fw-bold">@record.WerkNames</div>
                                </td>
                                <td>
                                    <div>@record.OrchesterName</div>
                                    <div class="text-muted small">@record.DirigentName</div>
                                </td>
                                <td class="small">@record.SolistNames</td>
                                <td class="small text-muted">@record.Spielsaison</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-link text-dark dropdown-toggle" type="button" id="dropdownMenuButton-@record.Id" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton-@record.Id">
                                            <li>
                                                <a class="dropdown-item" role="button" @onclick="() => OpenNoteModal(record)">
                                                    <i class="fas fa-envelope me-2 text-warning"></i> Note
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" role="button" @onclick="() => OpenDetailsModal(record)">
                                                    <i class="fas fa-info-circle me-2 text-info"></i> Details
                                                </a>
                                            </li>

                                            <AuthorizeView Roles="Admin, Operator" Context="adminItemContext">
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item" role="button" @onclick="() => OpenUploadModal(record)">
                                                        <i class="fas fa-upload me-2 text-success"></i> Upload
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" role="button" @onclick="() => Edit(record.Id)">
                                                        <i class="fas fa-edit me-2 text-primary"></i> Bearbeiten
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger" role="button" @onclick="() => OpenDeleteModal(record)">
                                                        <i class="fas fa-trash me-2"></i> Löschen
                                                    </a>
                                                </li>
                                            </AuthorizeView>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3 class="mb-4">Meine Konzerte</h3>
            <p> <img src="Images/dresden.jpg" class="img-fluid rounded shadow" style="max-height: 500px;" /> </p>
            <p class="mt-4">Bitte melden Sie sich an, um auf die Konzertdatenbank zuzugreifen.</p>
            <a href="/login" class="btn btn-primary btn-lg mt-2">Zum Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@* --- Modals --- *@

<ModalDialog Title="Notiz bearbeiten" Show="@ShowNoteModal" OnClose="@CloseNoteModal" ShowFooter="true">
    <ChildContent>
        @if (NoteRecord != null)
        {
            <div class="form-group">
                <label class="form-label">Bewertung / Notiz:</label>
                <textarea class="form-control" rows="10" @bind="NoteRecord.Bewertung"></textarea>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-secondary" @onclick="() => CloseNoteModal(false)">Abbrechen</button>
        <button class="btn btn-primary" @onclick="SaveNote">Speichern</button>
    </FooterContent>
</ModalDialog>

<ModalDialog Title="Details & Dokumente" Show="@ShowDetailsModal" OnClose="@CloseDetailsModal" ShowFooter="false">
    <ChildContent>
        @if (DetailsRecord != null)
        {
            <div class="mb-3">
                <h5>@DetailsRecord.KomponistNames: @DetailsRecord.WerkNames</h5>
                <p>
                    <strong>Ort:</strong> @DetailsRecord.Ort <br />
                    <strong>Datum:</strong> @DetailsRecord.Datum.ToString("dd.MM.yyyy")
                </p>
            </div>

            <hr />

            @if (Service.HasDocuments(DetailsRecord.Id))
            {
                <h6>Dokumente:</h6>
                @foreach (DOC item in Service.GetDocuments(DetailsRecord.Id))
                {
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                        <div>
                            <a href="@item.path" target="_blank" class="text-decoration-none d-block">
                                <i class="fas fa-file-pdf me-2 text-danger"></i> @item.fn
                            </a>
                            <div class="form-check mt-1 ms-4">
                                <input class="form-check-input" type="checkbox" checked="@item.Vormerken" @onchange="@(e => ToggleVormerken(item, e))" id="chk-doc-@item.id">
                                <label class="form-check-label small text-muted" for="chk-doc-@item.id">Vormerken für Export</label>
                            </div>
                        </div>
                        <AuthorizeView Roles="Admin, Operator" Context="docAdmin">
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteFile(item.id)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </AuthorizeView>
                    </div>
                }

                <h6 class="mt-3">Bilder:</h6>
                @foreach (DOC item in Service.GetImages(DetailsRecord.Id))
                {
                    <div class="mb-3 p-2 border rounded">
                        <img src="@item.path" alt="@item.fn" class="img-fluid mb-2" />
                        <div class="d-flex justify-content-between">
                             <div>
                                 <span class="text-muted small d-block">@item.fn</span>
                                 <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" checked="@item.Vormerken" @onchange="@(e => ToggleVormerken(item, e))" id="chk-img-@item.id">
                                    <label class="form-check-label small text-muted" for="chk-img-@item.id">Vormerken für Export</label>
                                </div>
                             </div>
                             <AuthorizeView Roles="Admin, Operator" Context="imgAdmin">
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteFile(item.id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                             </AuthorizeView>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Keine Dokumente oder Bilder vorhanden.</p>
            }
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Daten Exportieren" Show="@ShowExportModal" OnClose="@CloseExportModal" ShowFooter="true">
    <ChildContent>
        <div class="form-group">
            <label class="form-label">Von:</label>
            <input type="date" class="form-control" @bind="ExportFrom" />
        </div>
        <div class="form-group mt-3">
            <label class="form-label">Bis:</label>
            <input type="date" class="form-control" @bind="ExportTo" />
        </div>
    </ChildContent>
    <FooterContent>
        <button class="btn btn-secondary" @onclick="() => CloseExportModal(false)">Abbrechen</button>
        <button class="btn btn-primary" @onclick="DoExport">Exportieren</button>
    </FooterContent>
</ModalDialog>

<ModalDialog Title="Datei hochladen" Show="@ShowUploadModal" OnClose="@CloseUploadModalWrapper" ShowFooter="false">
    <ChildContent>
        @if (UploadRecord != null)
        {
             <Upload currentRecord="@UploadRecord" CloseUploadCallback="@CloseUploadCallback" />
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Datensatz löschen" Show="@ShowDeleteModal" OnClose="@CloseDeleteModalWrapper" ShowFooter="false">
    <ChildContent>
        <div class="alert alert-warning">
            Möchten Sie diesen Datensatz wirklich löschen?
        </div>
        @if (DeleteRecordId != 0)
        {
            <Delete CloseDeleteCallback="@CloseDeleteCallback" />
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="@("Stammdaten: " + MasterType)" Show="@ShowMasterListModal" OnClose="@CloseMasterListModal" ShowFooter="false">
    <ChildContent>
        <div style="max-height: 400px; overflow: auto; background-color: white;">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        @if (MasterType == "Dirigent" || MasterType == "Solist" || MasterType == "Komponist")
                        {
                            <th>Vorname</th>
                            <th>Name</th>
                        }
                        else
                        {
                            <th>Name</th>
                        }

                        @if (MasterType == "Werk")
                        {
                            <th>Komponist</th>
                        }

                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in MasterList)
                    {
                        <tr>
                            @if (MasterType == "Dirigent")
                            {
                                var d = (Dirigent)item;
                                <td>@d.Vorname</td>
                                <td>@d.Name</td>
                            }
                            else if (MasterType == "Solist")
                            {
                                var s = (Solist)item;
                                <td>@s.Vorname</td>
                                <td>@s.Name</td>
                            }
                            else if (MasterType == "Komponist")
                            {
                                var k = (Komponist)item;
                                <td>@k.Vorname</td>
                                <td>@k.Name</td>
                            }
                            else if (MasterType == "Orchester")
                            {
                                var o = (Orchester)item;
                                <td>@o.Name</td>
                            }
                            else if (MasterType == "Ort")
                            {
                                var o = (Ort)item;
                                <td>@o.Name</td>
                            }
                            else if (MasterType == "Werk")
                            {
                                var w = (Werk)item;
                                <td>@w.Name</td>
                                <td>@(w.Komponist?.Name ?? "-")</td>
                            }

                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenMasterEdit(item)">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </ChildContent>
</ModalDialog>

<ModalDialog Title="@("Bearbeiten: " + MasterType)" Show="@ShowMasterEditModal" OnClose="@CloseMasterEditModal" ShowFooter="true">
    <ChildContent>
        @if (EditMasterItem != null)
        {
            <div class="form-group mb-2">
                @if (MasterType == "Dirigent")
                {
                    var d = (Dirigent)EditMasterItem;
                    <div class="row">
                        <div class="col">
                            <label>Vorname</label>
                            <input type="text" class="form-control" @bind="d.Vorname" />
                        </div>
                        <div class="col">
                            <label>Name</label>
                            <input type="text" class="form-control" @bind="d.Name" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>Geboren</label>
                        <input type="date" class="form-control" @bind="d.Born" />
                    </div>
                    <div class="mt-2">
                        <label>Gestorben</label>
                        <input type="date" class="form-control" @bind="d.Died" />
                    </div>
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="d.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
                else if (MasterType == "Solist")
                {
                    var s = (Solist)EditMasterItem;
                    <div class="row">
                        <div class="col">
                            <label>Vorname</label>
                            <input type="text" class="form-control" @bind="s.Vorname" />
                        </div>
                        <div class="col">
                            <label>Name</label>
                            <input type="text" class="form-control" @bind="s.Name" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>Geboren</label>
                        <input type="date" class="form-control" @bind="s.Born" />
                    </div>
                    <div class="mt-2">
                        <label>Gestorben</label>
                        <input type="date" class="form-control" @bind="s.Died" />
                    </div>
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="s.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
                else if (MasterType == "Komponist")
                {
                    var k = (Komponist)EditMasterItem;
                    <div class="row">
                        <div class="col">
                            <label>Vorname</label>
                            <input type="text" class="form-control" @bind="k.Vorname" />
                        </div>
                        <div class="col">
                            <label>Name</label>
                            <input type="text" class="form-control" @bind="k.Name" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>Geboren</label>
                        <input type="date" class="form-control" @bind="k.Born" />
                    </div>
                    <div class="mt-2">
                        <label>Gestorben</label>
                        <input type="date" class="form-control" @bind="k.Died" />
                    </div>
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="k.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
                else if (MasterType == "Orchester")
                {
                    var o = (Orchester)EditMasterItem;
                    <label>Name</label>
                    <input type="text" class="form-control" @bind="o.Name" />
                     <div class="mt-2">
                        <label>Gegründet</label>
                        <input type="date" class="form-control" @bind="o.Founded" />
                    </div>
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="o.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
                else if (MasterType == "Ort")
                {
                    var o = (Ort)EditMasterItem;
                    <label>Name</label>
                    <input type="text" class="form-control" @bind="o.Name" />
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="o.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
                else if (MasterType == "Werk")
                {
                    var w = (Werk)EditMasterItem;
                    <label>Name</label>
                    <input type="text" class="form-control" @bind="w.Name" />

                    <div class="mt-2">
                         <label>Komponist</label>
                         <select class="form-select" @bind="w.KomponistId">
                            <option value="">Bitte wählen...</option>
                            @foreach (var k in AllKomponisten)
                            {
                                <option value="@k.Id">@k.Name, @k.Vorname</option>
                            }
                         </select>
                    </div>
                    <div class="mt-2">
                        <label>Notiz</label>
                        <textarea class="form-control" rows="3" @bind="w.Note"></textarea>
                    </div>
                    <div class="mt-2">
                         <button type="button" class="btn btn-sm btn-info" @onclick="FillMasterAi">AI Vervollständigen</button>
                    </div>
                }
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-secondary" @onclick="() => CloseMasterEditModal(false)">Abbrechen</button>
        <button class="btn btn-primary" @onclick="SaveMasterItem">Speichern</button>
    </FooterContent>
</ModalDialog>

<ModalDialog Title="KI Vervollständigen" Show="@ShowAiFillModal" OnClose="@CloseAiFillModal" ShowFooter="false">
    <ChildContent>
        @if (IsAiProcessing)
        {
            <div class="text-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3">@AiProgressMessage</h5>
                <p>Verarbeite @AiProgressCurrent von @AiProgressTotal</p>
                <progress value="@AiProgressCurrent" max="@AiProgressTotal" class="w-100"></progress>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkKomponist" @bind="fillKomponist">
                        <label class="form-check-label" for="chkKomponist">Komponist</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkDirigent" @bind="fillDirigent">
                        <label class="form-check-label" for="chkDirigent">Dirigent</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkSolist" @bind="fillSolist">
                        <label class="form-check-label" for="chkSolist">Solist</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkOrchester" @bind="fillOrchester">
                        <label class="form-check-label" for="chkOrchester">Orchester</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkWerk" @bind="fillWerk">
                        <label class="form-check-label" for="chkWerk">Werk</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkOrt" @bind="fillOrt">
                        <label class="form-check-label" for="chkOrt">Ort</label>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                 <button class="btn btn-secondary" @onclick="() => CloseAiFillModal(false)">Abbrechen</button>
                 <button class="btn btn-primary" @onclick="StartAiFill">Starten</button>
            </div>
        }
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Benutzerverwaltung" Show="@ShowUserListModal" OnClose="@CloseUserListModal" ShowFooter="false">
    <ChildContent>
        <div class="mb-2 text-end">
            <button class="btn btn-primary btn-sm" @onclick="OpenUserAddModal">
                <i class="fas fa-plus"></i> Neuer Benutzer
            </button>
        </div>
        <div style="max-height: 400px; overflow: auto; background-color: white;">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Rolle</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in UserList)
                    {
                        <tr>
                            <td>@user.Name</td>
                            <td>@user.Email</td>
                            <td>@user.UserLevel</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => OpenUserEditModal(user)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteUser(user)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </ChildContent>
</ModalDialog>

<ModalDialog Title="Benutzer bearbeiten" Show="@ShowUserEditModal" OnClose="@CloseUserEditModal" ShowFooter="true">
    <ChildContent>
        @if (EditUserItem != null)
        {
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" @bind="EditUserItem.Name" />
            </div>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" @bind="EditUserItem.Email" />
            </div>
            <div class="mb-3">
                <label class="form-label">Rolle</label>
                <select class="form-select" @bind="EditUserItem.UserLevel">
                    <option value="@UserLevel.Viewer">Viewer</option>
                    <option value="@UserLevel.Operator">Operator</option>
                    <option value="@UserLevel.Admin">Admin</option>
                </select>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-secondary" @onclick="() => CloseUserEditModal(false)">Abbrechen</button>
        <button class="btn btn-primary" @onclick="SaveUser">Speichern</button>
    </FooterContent>
</ModalDialog>

@code {
    private Dictionary<int, string> limitOptions = new() { { 5, "Letzte 5" }, { 10, "Letzte 10" }, { 0, "All" } };
    private int selectedLimit = 5;

    private const string AiErrorMessage = "KI konnte leider keine Antwort finden";

    // Search properties
    private List<string> searchCategories = new() { "Werk", "Komponist", "Dirigent", "Ort", "Solist", "Orchester", "Note", "Datum", "Saisson" };

    private string _searchCategory = "Werk";
    private string searchCategory
    {
        get => _searchCategory;
        set
        {
            _searchCategory = value;
            searchTerm = "";
            searchDateFrom = null;
            searchDateTo = null;
        }
    }

    private string searchTerm = "";
    private DateTime? searchDateFrom;
    private DateTime? searchDateTo;

    // Dropdown lists
    private List<string> availableWerke = new();
    private List<string> availableKomponisten = new();
    private List<string> availableDirigenten = new();
    private List<string> availableSolisten = new();
    private List<string> availableOrchester = new();
    private List<string> availableOrte = new();
    private List<string> availableSaisons = new();

    private List<MusicRecordDisplayDto> MusicRecords = new();

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try
                {
                    // Load lists
                    availableWerke = Service.GetUsedWerkeNames();
                    availableKomponisten = Service.GetUsedKomponistenNames();
                    availableDirigenten = Service.GetUsedDirigentenNames();
                    availableSolisten = Service.GetUsedSolistenNames();
                    availableOrchester = Service.GetUsedOrchesterNames();
                    availableOrte = Service.GetUsedOrte();
                    availableSaisons = Service.GetUsedSaisons();

                    RefreshList();
                }
                catch (Exception ex)
                {
                    // Log error or handle gracefully
                    Console.WriteLine($"Error loading data: {ex.Message}");
                }
            }
        }
    }

    private void RefreshList()
    {
        MusicRecords = Service.GetDisplayRecords(searchCategory, searchTerm, searchDateFrom, searchDateTo, selectedLimit);
    }

    private void Display(ChangeEventArgs a)
    {
        if (int.TryParse(a?.Value?.ToString(), out int val))
        {
            selectedLimit = val;
            RefreshList();
        }
    }

    private string GetNumber()
    {
        return MusicRecords.Count.ToString();
    }

    // --- Modal State Management ---

    // Note Modal
    private bool ShowNoteModal = false;
    private MusicRecord? NoteRecord;

    private void OpenNoteModal(MusicRecordDisplayDto record)
    {
        NoteRecord = Service.GetRecordById(record.Id);
        ShowNoteModal = true;
    }

    private async Task SaveNote()
    {
        if (NoteRecord != null)
        {
            await Service.SaveDataSet(NoteRecord);
            ShowNoteModal = false;
            NoteRecord = null;
            RefreshList();
        }
    }

    private Task CloseNoteModal(bool result)
    {
        ShowNoteModal = false;
        NoteRecord = null;
        return Task.CompletedTask;
    }

    // Details Modal
    private bool ShowDetailsModal = false;
    private MusicRecordDisplayDto? DetailsRecord;

    private void OpenDetailsModal(MusicRecordDisplayDto record)
    {
        DetailsRecord = record;
        ShowDetailsModal = true;
    }

    private Task CloseDetailsModal(bool result)
    {
        ShowDetailsModal = false;
        DetailsRecord = null;
        return Task.CompletedTask;
    }

    // Upload Modal
    private bool ShowUploadModal = false;
    private MusicRecord? UploadRecord;

    private void OpenUploadModal(MusicRecordDisplayDto record)
    {
        UploadRecord = Service.GetRecordById(record.Id);
        ShowUploadModal = true;
    }

    private Task CloseUploadModalWrapper(bool result)
    {
        ShowUploadModal = false;
        UploadRecord = null;
        return Task.CompletedTask;
    }

    private async Task CloseUploadCallback(bool result)
    {
        ShowUploadModal = false;
        UploadRecord = null;
        RefreshList(); // Refresh to show potential changes if any, though uploads are separate
        await Task.CompletedTask;
    }

    // Delete Modal
    private bool ShowDeleteModal = false;
    private int DeleteRecordId = 0;

    private void OpenDeleteModal(MusicRecordDisplayDto record)
    {
        DeleteRecordId = record.Id;
        ShowDeleteModal = true;
    }

    private Task CloseDeleteModalWrapper(bool result)
    {
        ShowDeleteModal = false;
        DeleteRecordId = 0;
        return Task.CompletedTask;
    }

    private async Task CloseDeleteCallback(bool del)
    {
        if (del && DeleteRecordId != 0)
        {
            await Service.DeleteDataSet(DeleteRecordId);
            RefreshList();
            StateHasChanged();
        }
        ShowDeleteModal = false;
        DeleteRecordId = 0;
    }

    // --- Edit (Full) ---
    private MusicRecord? EditMusicRecord;

    private void AddNew()
    {
        EditMusicRecord = new MusicRecord();
    }

    private void Edit(int id)
    {
        EditMusicRecord = Service.GetRecordById(id);
    }

    private async Task CloseEdit(bool result)
    {
        if (result && EditMusicRecord is not null)
            await Save(EditMusicRecord);
        EditMusicRecord = null;
        RefreshList();
    }

    private async Task Save(MusicRecord? n)
    {
        if (n is null) return;
        await Service.SaveDataSet(n);
    }

    // --- Document Deletion ---
    private async Task DeleteFile(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirmDeletion", "Soll die Datei wirklich gelöscht werden?");
        if (confirmed)
        {
            string message = await Service.DeleteDocument(id);
            await ShowInfo(message);
            // Refresh details view if open? The service returns void, we manually updated lists.
            // But Service.GetDocuments pulls from DB or folder.
            // StateHasChanged handles re-render of the modal content.
        }
    }

    private async Task ToggleVormerken(DOC item, ChangeEventArgs e)
    {
        if (bool.TryParse(e.Value?.ToString(), out bool val))
        {
            await Service.UpdateDocumentVormerken(item.id, val);
            item.Vormerken = val; // Update UI state locally
        }
    }

    private bool showMessage = false;
    private string messageText = "";
    private async Task ShowInfo(string m)
    {
        messageText = m;
        showMessage = true;
        StateHasChanged();
        await Task.Delay(3000);
        showMessage = false;
        StateHasChanged();
    }

    // --- Master Data Management ---

    private bool ShowMasterListModal = false;
    private string MasterType = "";
    private List<object> MasterList = new();

    // Edit State
    private bool ShowMasterEditModal = false;
    private dynamic? EditMasterItem; // Using dynamic to bind fields regardless of type
    private List<Komponist> AllKomponisten = new();

    private void OpenMasterList(string type)
    {
        MasterType = type;
        LoadMasterList();
        ShowMasterListModal = true;
    }

    private void LoadMasterList()
    {
        MasterList.Clear();
        switch (MasterType)
        {
            case "Dirigent":
                MasterList = Service.GetAllDirigentenNoTracking().Cast<object>().ToList();
                break;
            case "Orchester":
                MasterList = Service.GetAllOrchesterNoTracking().Cast<object>().ToList();
                break;
            case "Solist":
                MasterList = Service.GetAllSolistenNoTracking().Cast<object>().ToList();
                break;
            case "Werk":
                MasterList = Service.GetAllWerkeNoTracking().Cast<object>().ToList();
                break;
            case "Komponist":
                MasterList = Service.GetAllKomponistenNoTracking().Cast<object>().ToList();
                break;
            case "Ort":
                MasterList = Service.GetAllOrteNoTracking().Cast<object>().ToList();
                break;
        }
    }

    private Task CloseMasterListModal(bool result)
    {
        ShowMasterListModal = false;
        return Task.CompletedTask;
    }

    private void OpenMasterEdit(object item)
    {
        // Clone the item to avoid modifying the list directly before saving
        // This prevents the UI from showing changes if the user cancels
        var options = new JsonSerializerOptions { ReferenceHandler = ReferenceHandler.IgnoreCycles };
        var json = JsonSerializer.Serialize(item, options);

        switch (MasterType)
        {
            case "Dirigent":
                EditMasterItem = JsonSerializer.Deserialize<Dirigent>(json, options);
                break;
            case "Orchester":
                EditMasterItem = JsonSerializer.Deserialize<Orchester>(json, options);
                break;
            case "Solist":
                EditMasterItem = JsonSerializer.Deserialize<Solist>(json, options);
                break;
            case "Werk":
                var w = JsonSerializer.Deserialize<Werk>(json, options);
                // Prevent EF Core tracking issues with the related entity
                // We only want to update the FK (KomponistId)
                if (w != null) w.Komponist = null;
                EditMasterItem = w;
                AllKomponisten = Service.GetAllKomponistenNoTracking().OrderBy(k => k.Name).ToList();
                break;
            case "Komponist":
                EditMasterItem = JsonSerializer.Deserialize<Komponist>(json, options);
                break;
            case "Ort":
                EditMasterItem = JsonSerializer.Deserialize<Ort>(json, options);
                break;
        }

        ShowMasterEditModal = true;
    }

    private Task CloseMasterEditModal(bool result)
    {
        ShowMasterEditModal = false;
        EditMasterItem = null;
        return Task.CompletedTask;
    }

    private async Task FillMasterAi()
    {
        if (EditMasterItem == null) return;

        string name = "";
        bool success = false;
        try
        {
            switch (MasterType)
            {
                case "Dirigent":
                    var d = (Dirigent)EditMasterItem;
                    name = $"{d.Vorname} {d.Name}".Trim();
                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var dRes = await AiService.RequestAiData(name, "Dirigent") as AiDirigentResponseDto;
                    if (dRes != null) { d.Born = dRes.Born; d.Died = dRes.Died; d.Note = dRes.Note; success = true; }
                    break;
                case "Solist":
                    var s = (Solist)EditMasterItem;
                    name = $"{s.Vorname} {s.Name}".Trim();
                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var sRes = await AiService.RequestAiData(name, "Solist") as AiSolistResponseDto;
                    if (sRes != null) { s.Born = sRes.Born; s.Died = sRes.Died; s.Note = sRes.Note; success = true; }
                    break;
                case "Komponist":
                    var k = (Komponist)EditMasterItem;
                    name = $"{k.Vorname} {k.Name}".Trim();
                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var kRes = await AiService.RequestAiData(name, "Komponist") as AiKomponistResponseDto;
                    if (kRes != null) { k.Born = kRes.Born; k.Died = kRes.Died; k.Note = kRes.Note ?? ""; success = true; }
                    break;
                case "Orchester":
                    var o = (Orchester)EditMasterItem;
                    name = o.Name;
                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var oRes = await AiService.RequestAiData(name, "Orchester") as AiOrchesterResponseDto;
                    if (oRes != null) { o.Founded = oRes.Founded; o.Note = oRes.Note; success = true; }
                    break;
                case "Ort":
                    var ort = (Ort)EditMasterItem;
                    name = ort.Name;
                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var ortRes = await AiService.RequestAiData(name, "Ort") as AiOrtResponseDto;
                    if (ortRes != null) { ort.Note = ortRes.Note; success = true; }
                    break;
                case "Werk":
                    var w = (Werk)EditMasterItem;
                    name = w.Name;
                    if (w.KomponistId != null)
                    {
                        var comp = AllKomponisten.FirstOrDefault(c => c.Id == w.KomponistId);
                        if (comp != null) name += $" ({comp.Vorname} {comp.Name})";
                    }

                    if (string.IsNullOrWhiteSpace(name)) throw new Exception("Name required");
                    var wRes = await AiService.RequestAiData(name, "Werk") as AiWerkResponseDto;
                    if (wRes != null) { w.Note = wRes.Note; success = true; }
                    break;
            }

            if (!success)
            {
                await JS.InvokeVoidAsync("alert", AiErrorMessage);
            }
        }
        catch (Exception ex)
        {
             Logger.LogError(ex, "Error in FillMasterAi");
             await JS.InvokeVoidAsync("alert", AiErrorMessage);
        }
    }

    private async Task SaveMasterItem()
    {
        if (EditMasterItem != null)
        {
            await Service.SaveAsync(EditMasterItem);

            // Reload the list to show updates
            LoadMasterList();

            // Close edit modal
            ShowMasterEditModal = false;
            EditMasterItem = null;

            // Refresh main list as names might have changed
            RefreshList();
        }
    }

    // --- AI Fill Modal ---
    private bool ShowAiFillModal = false;
    private bool IsAiProcessing = false;
    private string AiProgressMessage = "";
    private int AiProgressCurrent = 0;
    private int AiProgressTotal = 0;

    private bool fillKomponist = false;
    private bool fillDirigent = false;
    private bool fillSolist = false;
    private bool fillOrchester = false;
    private bool fillWerk = false;
    private bool fillOrt = false;

    private void OpenAiFillModal()
    {
        ShowAiFillModal = true;
        IsAiProcessing = false;
        // Keep selections
    }

    private Task CloseAiFillModal(bool result)
    {
        if (!IsAiProcessing)
        {
            ShowAiFillModal = false;
        }
        return Task.CompletedTask;
    }

    private async Task StartAiFill()
    {
        IsAiProcessing = true;
        AiProgressCurrent = 0;
        AiProgressTotal = 0;
        AiProgressMessage = "Analysiere Datenbestand...";
        StateHasChanged();

        try
        {
            // First pass: count totals
            var komps = fillKomponist ? Service.GetIncompleteKomponisten() : new List<Komponist>();
            var dirs = fillDirigent ? Service.GetIncompleteDirigenten() : new List<Dirigent>();
            var sols = fillSolist ? Service.GetIncompleteSolisten() : new List<Solist>();
            var orchs = fillOrchester ? Service.GetIncompleteOrchester() : new List<Orchester>();
            var werks = fillWerk ? Service.GetIncompleteWerke() : new List<Werk>();
            var orts = fillOrt ? Service.GetIncompleteOrte() : new List<Ort>();

            AiProgressTotal = komps.Count + dirs.Count + sols.Count + orchs.Count + werks.Count + orts.Count;

            if (AiProgressTotal == 0)
            {
                await ShowInfo("Keine unvollständigen Datensätze gefunden.");
                IsAiProcessing = false;
                ShowAiFillModal = false;
                return;
            }

            // Process
            if (fillKomponist) await ProcessList(komps, "Komponist");
            if (fillDirigent) await ProcessList(dirs, "Dirigent");
            if (fillSolist) await ProcessList(sols, "Solist");
            if (fillOrchester) await ProcessList(orchs, "Orchester");
            if (fillWerk) await ProcessList(werks, "Werk");
            if (fillOrt) await ProcessList(orts, "Ort");

            await ShowInfo("Vervollständigung abgeschlossen.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in AI Batch Fill");
            // Simple alert
            await JS.InvokeVoidAsync("alert", "Fehler: " + ex.Message);
        }
        finally
        {
            IsAiProcessing = false;
            ShowAiFillModal = false;
            RefreshList();
        }
    }

    private async Task ProcessList<T>(List<T> items, string type) where T : class
    {
        foreach (var item in items)
        {
            AiProgressMessage = $"Verarbeite {type}...";
            StateHasChanged(); // Ensure UI updates

            try
            {
                string name = "";
                // Determine name based on type
                if (item is Komponist komp) name = $"{komp.Vorname} {komp.Name}".Trim();
                else if (item is Dirigent dir) name = $"{dir.Vorname} {dir.Name}".Trim();
                else if (item is Solist sol) name = $"{sol.Vorname} {sol.Name}".Trim();
                else if (item is Orchester orch) name = orch.Name;
                else if (item is Ort ort) name = ort.Name;
                else if (item is Werk werk)
                {
                    name = werk.Name;
                    if (werk.Komponist != null) name += $" ({werk.Komponist.Vorname} {werk.Komponist.Name})";
                }

                if (!string.IsNullOrWhiteSpace(name))
                {
                    var result = await AiService.RequestAiData(name, type);

                    bool updated = false;
                    // Map result
                    if (type == "Komponist" && result is AiKomponistResponseDto kr)
                    {
                        var k = (Komponist)(object)item;
                        k.Born = kr.Born;
                        k.Died = kr.Died;
                        k.Note = kr.Note ?? "";
                        updated = true;
                    }
                    else if (type == "Dirigent" && result is AiDirigentResponseDto dr)
                    {
                        var d = (Dirigent)(object)item;
                        d.Born = dr.Born;
                        d.Died = dr.Died;
                        d.Note = dr.Note;
                        updated = true;
                    }
                    else if (type == "Solist" && result is AiSolistResponseDto sr)
                    {
                        var s = (Solist)(object)item;
                        s.Born = sr.Born;
                        s.Died = sr.Died;
                        s.Note = sr.Note;
                        updated = true;
                    }
                    else if (type == "Orchester" && result is AiOrchesterResponseDto or)
                    {
                        var o = (Orchester)(object)item;
                        o.Founded = or.Founded;
                        o.Note = or.Note;
                        updated = true;
                    }
                    else if (type == "Ort" && result is AiOrtResponseDto ortr)
                    {
                        var o = (Ort)(object)item;
                        o.Note = ortr.Note;
                        updated = true;
                    }
                    else if (type == "Werk" && result is AiWerkResponseDto wr)
                    {
                        var w = (Werk)(object)item;
                        w.Note = wr.Note;
                        updated = true;
                    }

                    if (updated)
                    {
                        await Service.SaveAsync(item);
                    }
                }
            }
            catch (Exception ex)
            {
                 Logger.LogError(ex, $"Error processing {type} item");
            }

            AiProgressCurrent++;
            StateHasChanged();
            await Task.Delay(10);
        }
    }

    private bool ShowExportModal = false;
    private DateOnly ExportFrom = new DateOnly(DateTime.Now.Year, 1, 1);
    private DateOnly ExportTo = new DateOnly(DateTime.Now.Year, 12, 31);

    private void OpenExportModal()
    {
        ExportFrom = new DateOnly(DateTime.Now.Year, 1, 1);
        ExportTo = new DateOnly(DateTime.Now.Year, 12, 31);
        ShowExportModal = true;
    }

    private Task CloseExportModal(bool result)
    {
        ShowExportModal = false;
        return Task.CompletedTask;
    }

    private async Task DoExport()
    {
        string? email = null;
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true && !string.IsNullOrEmpty(authState.User.Identity.Name))
            {
                 email = await Service.GetUserEmail(authState.User.Identity.Name);
            }
        }

        if (string.IsNullOrEmpty(email))
        {
            await ShowInfo("Konnte Email-Adresse nicht ermitteln.");
            return;
        }

        bool success = await Service.ExportRtf(ExportFrom, ExportTo, email);

        ShowExportModal = false;

        if (success)
            await ShowInfo("Export angestoßen. Bitte prüfen Sie Ihre Emails.");
        else
            await ShowInfo("Keine Daten für Export oder Fehler.");
    }

    // --- User Management ---
    private bool ShowUserListModal = false;
    private List<User> UserList = new();

    private void OpenUserListModal()
    {
        LoadUserList();
        ShowUserListModal = true;
    }

    private void LoadUserList()
    {
        UserList = Service.GetAllUsers();
    }

    private Task CloseUserListModal(bool result)
    {
        ShowUserListModal = false;
        return Task.CompletedTask;
    }

    private bool ShowUserEditModal = false;
    private User? EditUserItem;

    private void OpenUserAddModal()
    {
        EditUserItem = new User();
        ShowUserEditModal = true;
    }

    private void OpenUserEditModal(User user)
    {
        // Clone to avoid direct editing in list
        var options = new JsonSerializerOptions { ReferenceHandler = ReferenceHandler.IgnoreCycles };
        var json = JsonSerializer.Serialize(user, options);
        EditUserItem = JsonSerializer.Deserialize<User>(json, options);
        ShowUserEditModal = true;
    }

    private Task CloseUserEditModal(bool result)
    {
        ShowUserEditModal = false;
        EditUserItem = null;
        return Task.CompletedTask;
    }

    private async Task SaveUser()
    {
        if (EditUserItem != null)
        {
            // Validation
            if (string.IsNullOrWhiteSpace(EditUserItem.Name))
            {
                await JS.InvokeVoidAsync("alert", "Name ist erforderlich.");
                return;
            }
            if (string.IsNullOrWhiteSpace(EditUserItem.Email) || !System.Text.RegularExpressions.Regex.IsMatch(EditUserItem.Email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            {
                await JS.InvokeVoidAsync("alert", "Gültige Email-Adresse ist erforderlich.");
                return;
            }

            bool success = await Service.SaveUser(EditUserItem);
            if (success)
            {
                LoadUserList();
                ShowUserEditModal = false;
                EditUserItem = null;
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Fehler beim Speichern des Benutzers.");
            }
        }
    }

    private async Task DeleteUser(User user)
    {
        // Prevent self-deletion
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.Name == user.Name)
            {
                await JS.InvokeVoidAsync("alert", "Sie können Ihren eigenen Benutzer nicht löschen.");
                return;
            }
        }

        var confirmed = await JS.InvokeAsync<bool>("confirmDeletion", $"Soll der Benutzer '{user.Name}' wirklich gelöscht werden?");
        if (confirmed)
        {
            bool success = await Service.DeleteUser(user.Id);
            if (success)
            {
                LoadUserList();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Fehler beim Löschen des Benutzers.");
            }
        }
    }
}
