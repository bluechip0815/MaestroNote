@page "/"

@using Microsoft.AspNetCore.Components.Web
@using MaestroNotes.Data
@using static MaestroNotes.Data.MusicService

@inject MusicService Service
@inject IJSRuntime JS

<PageTitle>Meine Konzerte</PageTitle>

@if (showMessage)
{
    <div class="alert alert-info">
        @messageText
    </div>
}

@if (PageEnabled != AccessType.None)
{
    @if (EditMusicRecord is not null)
    {
        <h3>Bearbeiten</h3>
        <Edit currentRecord="EditMusicRecord" CloseCallback="@CloseNote" />
    }
    else
    {
        <div style="display: flex; flex-direction: row; align-items: center; gap: 10px; margin-bottom: 10px;">
            <select class="form-select" style="width: auto;" @bind="searchCategory">
                @foreach (var cat in searchCategories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>

            @if (searchCategory == "Datum")
            {
                <span>von</span>
                <input type="date" class="form-control" style="width: auto;" @bind="searchDateFrom" />
                <span>bis</span>
                <input type="date" class="form-control" style="width: auto;" @bind="searchDateTo" />
            }
            else if (searchCategory == "Note")
            {
                <input type="text" class="form-control" style="width: 200px;" @bind="searchTerm" placeholder="(* und ? möglich)" />
            }
            else
            {
                <select class="form-select" style="width: auto;" @bind="searchTerm">
                    <option value="">Bitte wählen...</option>
                    @if (searchCategory == "Werk")
                    {
                        @foreach (var item in availableWerke)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Komponist")
                    {
                        @foreach (var item in availableKomponisten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Dirigent")
                    {
                        @foreach (var item in availableDirigenten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Solist")
                    {
                        @foreach (var item in availableSolisten)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Orchester")
                    {
                        @foreach (var item in availableOrchester)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Ort")
                    {
                        @foreach (var item in availableOrte)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                    else if (searchCategory == "Saisson")
                    {
                        @foreach (var item in availableSaisons)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                </select>
            }

            <button class="btn btn-secondary" @onclick="RefreshList">Zeige</button>

            <span>@GetNumber() Datensätze</span>

            <select id="number" value="@selectedLimit" @onchange="Display">
                @foreach (var opt in limitOptions)
                {
                    <option value="@opt.Key">@opt.Value</option>
                }
            </select>
            @if (PageEnabled == AccessType.ReadWrite)
            {
                <button class="small-button" @onclick="() => AddNew()">
                    <i class="fas fa-cog"></i>
                </button>
            }
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th></th>
                    <th>Komponist</th>
                    <th>Werk</th>
                    <th>Orchester</th>
                    <th>Dirigent</th>
                    <th>Solist</th>
                    <th>Spielsaison</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var record in MusicRecords)
                {
                    <tr>
                        <td>
                            <div class="button-container">
                                <!-- Main content -->
                                <button class="small-button" @onclick="() => Show1(record)">
                                    <i class="fas fa-envelope"></i>
                                </button>
                                <button class="small-button" @onclick="() => Show2(record)">
                                    <i class="fas fa-home"></i>
                                </button>
                            </div>
                            @if (PageEnabled == AccessType.ReadWrite)
                            {
                                <div class="button-container">
                                    <!-- Main content -->
                                    <button class="small-button" @onclick="() => Upload(record)">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <button class="small-button" @onclick="() => Delete(record)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            }
                        </td>
                        <td>@record.KomponistNames</td>
                        <td>@record.WerkNames</td>
                        <td>@record.OrchesterName</td>
                        <td>@record.DirigentName</td>
                        <td>@record.SolistNames</td>
                        <td>@record.Spielsaison</td>
                    </tr>
                    @if (DeleteRecordId == record.Id)
                    {
                        <tr>
                            <td colspan="8" style="background-color:lightpink">
                                <Delete CloseDeleteCallback="@CloseDeleteCallback" />
                            </td>
                        </tr>
                    }
                    @if (UploadRecordId == record.Id)
                    {
                        <tr>
                            <td colspan="8" style="background-color:lightcyan">
                                <Upload currentRecord="@UploadMusicRecord" CloseUploadCallback="@CloseUploadCallback" />
                            </td>
                        </tr>
                    }
                    @if (currentRecord1 == record)
                    {
                        <tr>
                            <td>
                                @if (PageEnabled == AccessType.ReadWrite)
                                {
                                    <button class="small-button" @onclick="() => Edit(record.Id)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                }
                            </td>
                            <td colspan="7" style="background-color:azure">
                                <pre>@currentRecord1.Bewertung</pre>
                            </td>
                        </tr>
                    }
                    @if (currentRecord2 == record)
                    {
                        <tr>
                            <td>
                                @if (PageEnabled == AccessType.ReadWrite)
                                {
                                    <button class="small-button" @onclick="() => Edit(record.Id)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                }
                            </td>
                            <td colspan="7" style="background-color:azure">
                                <p>
                                    [@currentRecord2.Id]
                                    &nbsp;
                                    &nbsp;
                                    &nbsp;
                                    @currentRecord2.Ort (@currentRecord2.Datum.ToString("yyyy-MM-dd"))
                                </p>
                                @if (Service.HasDocuments(currentRecord2.Id))
                                {
                                    @foreach (DOC item in Service.GetDocuments(currentRecord2.Id))
                                    {
                                        <p>
                                            <a href="@item.path" target="_blank">@item.fn</a>
                                            <button class="small-button" @onclick="() => DeleteFile(item.id)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </p>
                                    }
                                    @foreach (DOC item in Service.GetImages(currentRecord2.Id))
                                    {
                                        <p>
                                            <img src="@item.path" alt="@item.fn" width="600px" />
                                            <button class="small-button" @onclick="() => DeleteFile(item.id)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </p>
                                    }
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
}
else
{
    <h3>Meine Konzerte</h3>
    <p> <img src="Images/dresden.jpg" width="99%" /> </p>
    <div class="form-group">
        <label> Logon:</label>
        <input type="text" @oninput="PageEnabler" id="EnablePage" size="5" />
    </div>
}

@code {
    private Dictionary<int, string> limitOptions = new() { { 5, "Letzte 5" }, { 10, "Letzte 10" }, { 0, "All" } };
    private int selectedLimit = 5;

    // Search properties
    private List<string> searchCategories = new() { "Werk", "Komponist", "Dirigent", "Ort", "Solist", "Orchester", "Note", "Datum", "Saisson" };

    private string _searchCategory = "Werk";
    private string searchCategory
    {
        get => _searchCategory;
        set
        {
            _searchCategory = value;
            searchTerm = "";
            searchDateFrom = null;
            searchDateTo = null;
        }
    }

    private string searchTerm = "";
    private DateTime? searchDateFrom;
    private DateTime? searchDateTo;

    // Dropdown lists
    private List<string> availableWerke = new();
    private List<string> availableKomponisten = new();
    private List<string> availableDirigenten = new();
    private List<string> availableSolisten = new();
    private List<string> availableOrchester = new();
    private List<string> availableOrte = new();
    private List<string> availableSaisons = new();

    private List<MusicRecordDisplayDto> MusicRecords = new();

    protected override void OnInitialized()
    {
        // Load lists
        availableWerke = Service.GetUsedWerkeNames();
        availableKomponisten = Service.GetUsedKomponistenNames();
        availableDirigenten = Service.GetUsedDirigentenNames();
        availableSolisten = Service.GetUsedSolistenNames();
        availableOrchester = Service.GetUsedOrchesterNames();
        availableOrte = Service.GetUsedOrte();
        availableSaisons = Service.GetUsedSaisons();

        RefreshList();
    }

    private void RefreshList()
    {
        MusicRecords = Service.GetDisplayRecords(searchCategory, searchTerm, searchDateFrom, searchDateTo, selectedLimit);
    }

    private void Display(ChangeEventArgs a)
    {
        if (int.TryParse(a?.Value?.ToString(), out int val))
        {
            selectedLimit = val;
            RefreshList();
        }
    }

    private string GetNumber()
    {
        return MusicRecords.Count.ToString();
    }

    private AccessType PageEnabled = AccessType.None;
    void PageEnabler(ChangeEventArgs eventArgs)
    {
        if (eventArgs != null)
        {
            var t = eventArgs.Value?.ToString() ?? string.Empty;
            if (t.Length >= 4)
            {
                PageEnabled = Service.EnablerTest(t);
                StateHasChanged();
            }
        }
    }

    // --- Detail Views ---
    private MusicRecordDisplayDto? currentRecord1 = null;
    private MusicRecordDisplayDto? currentRecord2 = null;

    private void Show1(MusicRecordDisplayDto n)
    {
        if (currentRecord1 is null)
        {
            currentRecord1 = n;
            currentRecord2 = null;
            UploadRecordId = 0;
            DeleteRecordId = 0;
        }
        else
            currentRecord1 = null;
    }
    private void Show2(MusicRecordDisplayDto n)
    {
        if (currentRecord2 is null)
        {
            currentRecord2 = n;
            currentRecord1 = null;
            UploadRecordId = 0;
            DeleteRecordId = 0;
        }
        else
            currentRecord2 = null;
    }

    // --- Edit / Add ---
    private MusicRecord? EditMusicRecord;

    private void AddNew()
    {
        EditMusicRecord = new MusicRecord();
    }

    private void Edit(int id)
    {
        EditMusicRecord = Service.GetRecordById(id);
        currentRecord1 = null;
        currentRecord2 = null;
    }

    private async Task CloseNote(bool result)
    {
        if (result && EditMusicRecord is not null)
            await Save(EditMusicRecord);
        EditMusicRecord = null;
        RefreshList();
    }

    private async Task Save(MusicRecord? n)
    {
        if (n is null) return;
        await Service.SaveDataSet(n);
    }

    // --- Delete ---
    private int DeleteRecordId = 0;

    private void Delete(MusicRecordDisplayDto n)
    {
        if (DeleteRecordId == 0)
        {
            DeleteRecordId = n.Id;
            currentRecord2 = null;
            currentRecord1 = null;
            UploadRecordId = 0;
        }
        else
            DeleteRecordId = 0;
    }

    private async Task CloseDeleteCallback(bool del)
    {
        if (del && DeleteRecordId != 0)
        {
            await Service.DeleteDataSet(DeleteRecordId);
            RefreshList();
            StateHasChanged();
        }
        DeleteRecordId = 0;
    }

    // --- Upload ---
    private int UploadRecordId = 0;
    private MusicRecord? UploadMusicRecord = null; // Needs full record for Upload component

    private void Upload(MusicRecordDisplayDto n)
    {
        if (UploadRecordId == 0)
        {
            UploadRecordId = n.Id;
            // Fetch full record because Upload component likely expects it
            UploadMusicRecord = Service.GetRecordById(n.Id);
            currentRecord1 = null;
            currentRecord2 = null;
            DeleteRecordId = 0;
        }
        else
        {
            UploadRecordId = 0;
            UploadMusicRecord = null;
        }
    }

    private async Task CloseUploadCallback()
    {
        UploadRecordId = 0;
        UploadMusicRecord = null;
        StateHasChanged();
        await Task.CompletedTask;
    }

    // --- Document Deletion ---
    private async Task DeleteFile(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirmDeletion", "Soll die Datei wirklich gelöscht werden?");
        if (confirmed)
        {
            string message = await Service.DeleteDocument(id);
            await ShowInfo(message);
        }
    }

    private bool showMessage = false;
    private string messageText = "";
    private async Task ShowInfo(string m)
    {
        messageText = m;
        showMessage = true;
        StateHasChanged();
        await Task.Delay(3000);
        showMessage = false;
        StateHasChanged();
    }
}
