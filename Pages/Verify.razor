@page "/verify/{Token}"
@using MaestroNotes.Data
@using MaestroNotes.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject MusicService Service
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Verifying Login</PageTitle>

<div class="container mt-5">
    @if (error)
    {
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle me-2"></i>Fehler</h4>
            <p>Der Anmeldelink ist ung√ºltig oder abgelaufen.</p>
            <a href="/login" class="btn btn-primary">Zum Login</a>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Verifiziere Anmeldung...
        </div>
    }
</div>

@code {
    [Parameter]
    public string? Token { get; set; }

    private bool error = false;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            error = true;
            return;
        }

        var user = await Service.VerifyLoginToken(Token);
        if (user != null)
        {
            if (AuthStateProvider is CustomAuthenticationStateProvider auth)
            {
                auth.Login(user);
                Nav.NavigateTo("/");
            }
            else
            {
                error = true; // Should not happen if configured correctly
            }
        }
        else
        {
            error = true;
        }
    }
}
